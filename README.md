# Snoty Android App
Desktop application at https://github.com/silaslenz/snoty-desktop

# Code Outline

The Android app was developed using Android Studio and Kotlin, API min 21/ target 26.

These are the most important classes:

## Activities

Package `me.snoty.mobile.activities`

* `MainActivity` to help the user to set up the connection and display demo notification
* `CertificateScannerActivity` scans the QR code with the connection details and triggers storing them

## Handling the Notifications

Package `me.snoty.mobile.notifications`

* `ListenerService` is the core class that receives posted and removed notifications from the system (used via `ListenerServiceHelper`)
* `Repository` keeps track of the currently existing notifications and triggers further action (classes implementing the `ProcessorInterface`)
* `Filter` decides whether a notification from the system should be dismissed

## Server Connection

Packages `me.snoty.mobile.server.*`

* `NetworkPacketHandler` is responsible for encoding and decoding the Java objects into JSON objects for transmission (using the classes in package `protocol`)
* `ConnectionChecker` tries to establish the connection to the server (polling, a better option would be ![Google Cloud Messaging](https://developers.google.com/cloud-messaging/))
* `ConnectionHandler` class that triggers all requests and forwards responses; also responsible for initiating UI status updates
* `RequestDelegator` creates threads for sending and receiving queued packets based on the socket in `ConnectionChecker`
* `ServerFingerprintTrustManager` compares the SSLSocket certificate's fingerprint with the stored one

## Other classes

* `Cryptography` is used to generate the keys, store them and perform encryption and decryption of text: this is only used for the secret generated by the server.
* `Prerequesites` checks if the listener permission is granted, the QR code was scanned and the fingerprint is valid
* `ServerPreferences` accesses the stored connection details; either from memory or from the SharedPreferences (server secret is encrypted)

# Protocol
Message format available in [protocol.md](https://github.com/silaslenz/snoty-desktop/blob/master/protocol.md)

# NotificationListenerService Complications

Unfortunately we encountered annoying problems with the ListenerService: the app is supposed to bind to the listener, but on some occasions 
this binding seems to get lost. Since Android doesn't kill the service and rebinding also doesn't work, a zombie service is somewhere deep 
in the OS and can't be accessed anymore. This happened e.g. when we switched inside the IDE from normal mode to debug mode. 

It seems to be a caching problem of Android itself: (https://stackoverflow.com/questions/33530807/why-is-this-notificationlistenerservice-not-working).

